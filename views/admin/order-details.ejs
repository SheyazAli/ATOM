<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Order Details | Admin</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body { background:#f2e5e2; font-family:"Inter", sans-serif; }
    .content { margin-left:250px; padding:40px; }
    .card-box {
      background:#fff;
      border-radius:18px;
      padding:24px;
      margin-bottom:24px;
      box-shadow:0 4px 15px rgba(0,0,0,.08);
    }
    .product-img {
      width:64px; height:80px;
      object-fit:cover;
      border-radius:10px;
      border:1px solid #ddd;
    }
    .badge-active { background:#dcfce7; color:#166534; }
    .badge-cancelled { background:#fee2e2; color:#991b1b; }
    .badge-returned { background:#fff7ed; color:#9a3412; }
  </style>
</head>

<body>

<%- include('./adminPartials/adminSidebar') %>

<div class="content">

  <h2 class="fw-bold mb-4">
    Order #<%= order.orderNumber %>
  </h2>

  <!-- ORDER META -->
  <div class="card-box">
    <div class="row">
      <div class="col-md-4">
        <strong>User</strong><br>
        <%= user.first_name %> <%= user.last_name %><br>
        <%= user.email %>
      </div>

      <div class="col-md-4">
        <strong>Shipping Address</strong><br>
        <%= order.address.address_line_1 %><br>
        <%= order.address.city %>, <%= order.address.state %><br>
        <%= order.address.postal_code %>
      </div>

      <div class="col-md-4">
        <strong>Order Info</strong><br>
        Date: <%= new Date(order.created_at).toDateString() %><br>
        Payment: <%= order.paymentMethod %><br>
        Status: <%= order.status %>
      </div>
    </div>
  </div>

  <!-- ITEMS -->
  <div class="card-box">
    <h6 class="mb-3">Items</h6>

    <% items.forEach(item => { %>
      <div class="d-flex align-items-center gap-4 mb-3">
        <img src="/uploads/<%= item.image %>" class="product-img">

        <div class="flex-grow-1">
          <div class="fw-semibold"><%= item.name %></div>
          <div class="small text-muted">
            Size: <%= item.size %> |
            Ordered: <%= item.quantity %> |
            Cancelled: <%= item.cancelledQty %> |
            Returned: <%= item.returnedQty %> |
            Remaining: <%= item.remainingQty %>
          </div>

          <span class="badge
            <%= item.status === 'cancelled'
              ? 'badge-cancelled'
              : item.status === 'returned'
              ? 'badge-returned'
              : 'badge-active' %>">
            <%= item.status %>
          </span>

          <% if (item.message) { %>
            <div class="small text-muted mt-1">
              <strong>Reason:</strong> <%= item.message %>
            </div>
          <% } %>
        </div>

        <div class="fw-semibold">
          ₹<%= item.total %>
        </div>
      </div>
      <hr>
    <% }) %>
  </div>

  <!-- PRICE -->
  <div class="card-box">
    <strong>Subtotal:</strong> ₹<%= order.subtotal %><br>
    <strong>Shipping:</strong> ₹<%= order.shipping %><br>
    <strong>Total:</strong> ₹<%= order.total %>
  </div>

  <!-- UPDATE STATUS -->
  <div class="card-box">
    <h6 class="mb-3">Update Order Status</h6>

    <form id="updateOrderForm">
      <select class="form-select mb-3" name="status" required onchange="toggleReason(this.value)">
        <option value="confirmed">Confirmed</option>
        <option value="shipped">Shipped</option>
        <option value="delivered">Delivered</option>
        <option value="cancelled">Cancelled</option>
      </select>

      <textarea
        class="form-control mb-3 d-none"
        name="message"
        id="adminMessage"
        placeholder="Reason for cancellation"></textarea>

      <button class="btn btn-danger">Save Changes</button>
    </form>
  </div>

</div>

<script>
function toggleReason(val) {
  document.getElementById('adminMessage')
    .classList.toggle('d-none', val !== 'cancelled');
}

document.getElementById('updateOrderForm').addEventListener('submit', e => {
  e.preventDefault();

  fetch('/admin/orders/<%= order.orderNumber %>/update', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      status: e.target.status.value,
      message: e.target.message.value
    })
  })
  .then(res => res.json())
  .then(() => {
    Swal.fire('Updated', 'Order updated successfully', 'success')
      .then(() => window.location.href = '/admin/orders');
  });
});
</script>

</body>
</html>
