<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Revenue Dashboard | Admin</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background:#f2e5e2; font-family: Inter, sans-serif; }
    .content { margin-left:250px; padding:40px; }
    .card-box {
      background:#fff;
      border-radius:18px;
      padding:25px;
      box-shadow:0 4px 15px rgba(0,0,0,.08);
    }
    .stat-value { font-size:26px; font-weight:700; }
  </style>
</head>

<body>

<%- include('./adminPartials/adminSidebar') %>

<div class="content">

  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">Revenue Dashboard</h2>

    <form method="GET">
      <input type="hidden" name="download" value="excel">
      <button class="btn btn-outline-success">Export Excel</button>
    </form>
  </div>

  <!-- DATE FILTER -->
 <form class="row g-3 mb-4">
  <div class="col-md-2">
    <select name="range" class="form-select">
      <option value="">Custom</option>
      <option value="week" <%= range==='week'?'selected':'' %>>This Week</option>
      <option value="month" <%= range==='month'?'selected':'' %>>This Month</option>
      <option value="year" <%= range==='year'?'selected':'' %>>This Year</option>
    </select>
  </div>
  <div class="col-md-3">
    <input type="date" name="from" class="form-control" value="<%= from || '' %>">
  </div>
  <div class="col-md-3">
    <input type="date" name="to" class="form-control" value="<%= to || '' %>">
  </div>
  <div class="col-md-2">
    <button class="btn btn-primary w-100">Apply</button>
  </div>
</form>


  <!-- METRICS -->
  <div class="row g-4 mb-4">
    <div class="col-md-3">
      <div class="card-box">
        <div>Total Revenue</div>
        <div class="stat-value">₹ <%= metrics.totalRevenue %></div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card-box">
        <div>Discounts</div>
        <div class="stat-value text-danger">₹ <%= metrics.totalDiscount %></div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card-box">
        <div>Net Revenue</div>
        <div class="stat-value text-success">₹ <%= metrics.netRevenue %></div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card-box">
        <div>Total Orders</div>
        <div class="stat-value"><%= metrics.totalOrders %></div>
      </div>
    </div>
  </div>

  <!-- CHARTS -->
  <div class="row g-4">
    <div class="col-md-8">
      <div class="card-box">
        <h6>Revenue Trend</h6>
        <canvas id="revenueChart"></canvas>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card-box">
        <h6>Payment Distribution (%)</h6>
        <canvas id="paymentChart"></canvas>
      </div>
    </div>
    <div class="card-box mt-4">
  <h6 class="fw-semibold mb-3">Order Details</h6>
<div id="ordersTableWrapper">
<div class="table-responsive">
    <table class="table table-bordered table-sm align-middle">
      <thead class="table-light">
        <tr>
          <th>Order #</th>
          <th>Qty</th>
          <th>Cancelled</th>
          <th>Returned</th>
          <th>Date</th>
          <th>Payment</th>
          <th>Status</th>
          <th>Refund</th>
          <th>Subtotal</th>
          <th>Discount</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        <% tableData.forEach(o => { %>
          <tr style="cursor:pointer"
              onclick="window.location.href='/admin/orders/<%= o.orderNumber %>'">
            <td><%= o.orderNumber %></td>
            <td><%= o.quantity %></td>
            <td><%= o.cancelledQty %></td>
            <td><%= o.returnedQty %></td>
            <td><%= o.date %></td>
            <td><%= o.paymentMethod %></td>
            <td><%= o.paymentStatus %></td>
            <td class="text-danger">₹ <%= o.refundAmount %></td>
            <td>₹ <%= o.subtotal %></td>
            <td class="text-success">₹ <%= o.discount %></td>
            <td class="fw-semibold">₹ <%= o.total %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  <nav class="mt-3">
  <ul class="pagination justify-content-end">
    <% for (let i = 1; i <= totalPages; i++) { %>
      <li class="page-item <%= i === currentPage ? 'active' : '' %>">
        <button
          class="page-link"
          onclick="loadPage(<%= i %>)">
          <%= i %>
        </button>
      </li>
    <% } %>
  </ul>
</nav>
</div>
</nav>

  </div>
</div>

  </div>

</div>


<script>
  const revenueData = <%- JSON.stringify(dailyRevenue) %>;

  new Chart(document.getElementById('revenueChart'), {
    type: 'line',
    data: {
      labels: Object.keys(revenueData),
      datasets: [{
        label: 'Revenue',
        data: Object.values(revenueData),
        tension: 0.4
      }]
    },
    options: {
      plugins: { legend: { display: false } }
    }
  });

  new Chart(document.getElementById('paymentChart'), {
    type: 'doughnut',
    data: {
      labels: ['Paid %', 'Pending %', 'Refunded %', 'Cancelled %'],
      datasets: [{
        data: [
          <%= paymentStats.paid %>,
          <%= paymentStats.pending %>,
          <%= paymentStats.refunded %>,
          <%= paymentStats.cancelled %>
        ]
      }]
    },
    options: {
      plugins: {
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.label}: ${ctx.raw}%`
          }
        }
      }
    }
  });
</script>
<script>
  async function loadPage(page) {
    const params = new URLSearchParams(window.location.search);
    params.set('page', page);

    const res = await fetch(
      `${window.location.pathname}?${params.toString()}`,
      { headers: { Accept: 'application/json' } }
    );

    const data = await res.json();

    const tbody = document.querySelector('#ordersTableWrapper tbody');
    tbody.innerHTML = '';

    data.tableData.forEach(o => {
      tbody.innerHTML += `
        <tr style="cursor:pointer"
            onclick="window.location.href='/admin/orders/${o.orderNumber}'">
          <td>${o.orderNumber}</td>
          <td>${o.quantity}</td>
          <td>${o.cancelledQty}</td>
          <td>${o.returnedQty}</td>
          <td>${o.date}</td>
          <td>${o.paymentMethod}</td>
          <td>${o.paymentStatus}</td>
          <td class="text-danger">₹ ${o.refundAmount}</td>
          <td>₹ ${o.subtotal}</td>
          <td class="text-success">₹ ${o.discount}</td>
          <td class="fw-semibold">₹ ${o.total}</td>
        </tr>
      `;
    });

    // Update active page
    document.querySelectorAll('.pagination .page-item')
      .forEach((li, idx) => {
        li.classList.toggle('active', idx + 1 === data.currentPage);
      });

    window.history.pushState({}, '', `?${params.toString()}`);
  }
</script>

</body>
</html>
