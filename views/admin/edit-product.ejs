<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Edit Product | ATOM</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body { background:#f6eeec; font-family:Inter,sans-serif; }
    .content { margin-left:250px; padding:40px; }
    .card-box { background:#fff; border-radius:14px; padding:20px; margin-bottom:20px; }
    .variant-row { background:#faf7f6; padding:15px; border-radius:10px; margin-bottom:15px; }
    .variant-images img {
      width:46px; height:46px; object-fit:cover;
      border-radius:6px; margin-right:6px; border:1px solid #ddd;
    }
    .add-variant { cursor:pointer; color:#e0553f; font-weight:500; }
    .save-btn { background:#e0553f; color:#fff; border:none; padding:12px; border-radius:10px; }
    small.hint { font-size:12px; color:#6c757d; }
  </style>
</head>

<body>

<%- include('./adminPartials/adminSidebar') %>

<div class="content">
  <h3 class="fw-bold mb-4">Edit Product</h3>

  <form
    action="/admin/products/<%= product.product_id %>?_method=PUT"
    method="POST"
    enctype="multipart/form-data"
  >

    <!-- BASIC INFO -->
    <div class="card-box">
      <h6 class="fw-semibold mb-3">Basic Information</h6>

      <input class="form-control mb-3" name="title" value="<%= product.title %>" required>
      <textarea class="form-control mb-3" name="description"><%= product.description %></textarea>

      <select name="category_id" class="form-select">
        <% categories.forEach(cat => { %>
          <option value="<%= cat.category_id %>"
            <%= cat.category_id === product.category_id ? 'selected' : '' %>>
            <%= cat.name %>
          </option>
        <% }) %>
      </select>
    </div>

    <!-- PRICING -->
    <div class="card-box">
      <h6 class="fw-semibold mb-3">Pricing</h6>
      <div class="row">
        <div class="col-md-6">
          <input class="form-control" name="regular_price" type="number"
                 value="<%= product.regular_price %>" required>
        </div>
        <div class="col-md-6">
          <input class="form-control" name="sale_price" type="number"
                 value="<%= product.sale_price || '' %>">
        </div>
      </div>
    </div>

    <!-- VARIANTS -->
    <div class="card-box">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="fw-semibold mb-0">Variants (Color wise)</h6>
        <span class="add-variant" id="addVariantBtn">
          <i class="bi bi-plus-circle"></i> Add Color
        </span>
      </div>

      <div id="variantContainer"></div>
    </div>

    <!-- STATUS -->
    <div class="card-box">
      <div class="form-check mb-3">
        <input type="checkbox" name="status" class="form-check-input"
               <%= product.status ? 'checked' : '' %>>
        <label class="form-check-label">Set Active</label>
      </div>

      <button class="save-btn w-100">Update Product</button>
    </div>

  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const existingVariants = <%- JSON.stringify(colorVariants || {}) %>;
  let index = 0;

  const sizes = ['Small','Medium','Large','X-Large'];
  const colors = ['Black','White','Yellow','Green','Red','Grey','Purple','Blue','Orange'];

  /* ---------------- ADD / PREFILL COLOR VARIANT ---------------- */

  function addColorVariant(prefill = null) {
    const container = document.getElementById('variantContainer');
    const div = document.createElement('div');
    div.className = 'variant-row';

    div.innerHTML = `
      <div class="row g-2 mb-2">
        <div class="col-md-3">
          <select name="variants[${index}][color]" class="form-select" required>
            ${colors.map(c =>
              `<option value="${c}" ${prefill?.color === c ? 'selected' : ''}>${c}</option>`
            ).join('')}
          </select>
        </div>

        <div class="col-md-5">
          <input type="file"
            name="variants[${index}][images]"
            class="form-control"
            accept="image/*"
            multiple>

          <small class="hint">Upload only if you want to replace images</small>

          ${prefill?.images?.length ? `
            <div class="variant-images mt-2">
              ${prefill.images.map(img => `<img src="/uploads/${img}">`).join('')}
            </div>

            ${prefill.images.map(img => `
              <input type="hidden"
                name="variants[${index}][existingImages][]"
                value="${img}">
            `).join('')}
          ` : ''}
        </div>
      </div>

      ${sizes.map(size => `
        <div class="row g-2 mb-1">
          <div class="col-md-3">
            <input class="form-control" value="${size}" disabled>
          </div>
          <div class="col-md-3">
            <input type="number"
              name="variants[${index}][sizes][${size}][stock]"
              class="form-control"
              value="${prefill?.sizes?.[size] ?? ''}"
              placeholder="Stock">
          </div>
        </div>
      `).join('')}
    `;

    container.appendChild(div);
    index++;
  }

  /* ---------------- PREFILL EXISTING VARIANTS ---------------- */
  Object.values(existingVariants).forEach(v => addColorVariant(v));

  /* ---------------- ADD NEW COLOR VARIANT ---------------- */
  document.getElementById('addVariantBtn').addEventListener('click', () => {
    addColorVariant();   // empty variant
  });

});
</script>

</body>
</html>
