<%- include('./userPartials/navbar') %>

<style>
  body { background:#fafafa; }

  .checkout-card {
    background:#fff;
    border-radius:12px;
    padding:20px;
    margin-bottom:16px;
    border:1px solid #eaeaea;
  }

  .address p {
    margin:4px 0;
    font-size:14px;
  }

  .payment-option {
    border:1px solid #e5e7eb;
    border-radius:10px;
    padding:14px;
    display:flex;
    align-items:center;
    gap:10px;
    cursor:pointer;
    margin-bottom:10px;
    font-size:14px;
  }

  .payment-option input {
    accent-color:#111;
  }

  .payment-option.disabled {
    opacity:.5;
    cursor:not-allowed;
  }

  .product {
    display:flex;
    gap:12px;
    margin-bottom:14px;
  }

  .product img {
    width:70px;
    aspect-ratio:5/7;
    object-fit:cover;
    border-radius:6px;
    background:#eee;
  }

  .product-name {
    font-size:14px;
    font-weight:500;
  }

  .price {
    margin-left:auto;
    font-weight:500;
  }

  .summary-box {
    background:#fff;
    border-radius:12px;
    padding:20px;
    border:1px solid #eaeaea;
    position:sticky;
    top:20px;
  }

  .divider {
    height:1px;
    background:#eee;
    margin:16px 0;
  }

  .row-line {
    display:flex;
    justify-content:space-between;
    font-size:14px;
    margin:8px 0;
  }

  .total {
    font-size:16px;
    font-weight:600;
  }

  .pay-btn {
    width:100%;
    margin-top:20px;
    background:#5cb85c;
    color:#fff;
    border:none;
    border-radius:10px;
    padding:14px;
    font-size:15px;
    cursor:pointer;
  }

  .pay-btn:hover {
    background:#7ace7a;
  }
  .cart-btn{
    width:100%;
    margin-top:20px;
    background:#111827;
    color:#fff;
    border:none;
    border-radius:10px;
    padding:14px;
    font-size:15px;
    cursor:pointer;
  }
  .cart-btn:hover {
    background:#000;
  }
</style>

<div class="container py-4">
  <div class="row">

    <!-- LEFT COLUMN -->
    <div class="col-lg-7 col-md-7">

      <!-- ADDRESS -->
      <div class="checkout-card address">
        <h6 class="fw-semibold mb-3">Ship to</h6>

        <div id="selectedAddress">
          <% if (defaultAddress) { %>
            <p><strong><%= user.name %></strong></p>
            <p><%= defaultAddress.building_name %></p>
            <p><%= defaultAddress.address_line_1 %></p>
            <p>
              <%= defaultAddress.city %>,
              <%= defaultAddress.state %>
              <%= defaultAddress.postal_code %>
            </p>
            <p><%= defaultAddress.country %></p>
          <% } else { %>
            <p class="text-muted">No address found</p>
          <% } %>
        </div>

        <div class="mt-3">
          <select class="form-select" id="addressSelect">
            <% addresses.forEach(addr => { %>
              <option
                value="<%= addr.address_id %>"
                <%= defaultAddress && addr.address_id === defaultAddress.address_id ? 'selected' : '' %>>
                <%= addr.building_name %>, <%= addr.city %>, <%= addr.state %>
              </option>
            <% }) %>
            <option value="add_new">➕ Add new address</option>
          </select>
        </div>
      </div>

      <!-- PAYMENT -->
      <div class="checkout-card">
        <h6 class="fw-semibold mb-2">Payment</h6>
        <p class="text-muted small mb-3">All transactions are secure and encrypted.</p>

        <label class="payment-option">
          <input type="radio" name="paymentMethod" value="razorpay" checked>
          Cards, UPI, NetBanking, BNPL (Razorpay)
        </label>

        <label class="payment-option">
          <input type="radio" name="paymentMethod" value="cod">
          Cash on Delivery (COD)
        </label>

        <label class="payment-option">
          <input type="radio" name="paymentMethod" value="wallet">
          Wallet
        </label>

        <label class="payment-option disabled">
          <input type="radio" disabled>
          Pay Later (Coming Soon)
        </label>
      </div>

    </div>

    <!-- RIGHT COLUMN -->
    <div class="col-lg-5 col-md-5">
      <div class="summary-box">

        <h6 class="fw-semibold mb-3">Order Summary</h6>

        <% cart.items.forEach(item => { %>
          <div class="product">
            <img src="/uploads/<%= item.image %>" alt="<%= item.name %>">
            <div>
              <div class="product-name"><%= item.name %></div>
              <div class="text-muted small"><%= item.variant %></div>
              <div class="text-muted small">Qty x <%= item.quantity %></div>
            </div>
            <div class="price">₹ <%= item.price %></div>
          </div>
        <% }) %>

        <div class="divider"></div>

        <div class="row-line">
          <span>Subtotal</span>
          <span>₹ <%= cart.subtotal %></span>
        </div>

        <div class="row-line">
          <span>Shipping</span>
          <span>FREE</span>
        </div>

        <div class="divider"></div>

        <div class="row-line total">
          <span>Total</span>
          <span>₹ <%= cart.total %></span>
        </div>

        <form method="POST" action="/checkout/pay">
          <button class="pay-btn" type="submit">Pay now</button>
        </form>
        <form method="POST" action="/user/cart">
          <button class="cart-btn" type="submit">Back to cart</button>
        </form>

      </div>
    </div>

  </div>
</div>

<script>
  const addresses = <%- JSON.stringify(addresses) %>;

  const addressSelect = document.getElementById('addressSelect');
  const addressContainer = document.getElementById('selectedAddress');

  addressSelect?.addEventListener('change', function () {
    if (this.value === 'add_new') {
      window.location.href = '/user/address/add';
      return;
    }

    const addr = addresses.find(a => a.address_id === this.value);
    if (!addr) return;

    addressContainer.innerHTML = `
      <p><strong><%= user.name %></strong></p>
      <p>${addr.building_name}</p>
      <p>${addr.address_line_1}</p>
      <p>${addr.city}, ${addr.state} ${addr.postal_code}</p>
      <p>${addr.country}</p>
    `;
  });
</script>

<%- include('./userPartials/footer') %>
