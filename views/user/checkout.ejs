<%- include('./userPartials/navbar') %>

<style>
  body { background:#fafafa; }

  .checkout-card {
    background:#fff;
    border-radius:12px;
    padding:20px;
    margin-bottom:16px;
    border:1px solid #eaeaea;
  }

  .address p { margin:4px 0; font-size:14px; }

  .payment-option {
    border:1px solid #e5e7eb;
    border-radius:10px;
    padding:14px;
    display:flex;
    align-items:center;
    gap:10px;
    cursor:pointer;
    margin-bottom:10px;
    font-size:14px;
  }

  .payment-option input { accent-color:#111; }

  .summary-box {
    background:#fff;
    border-radius:12px;
    padding:20px;
    border:1px solid #eaeaea;
    position:sticky;
    top:20px;
  }

  .pay-btn {
    width:100%;
    margin-top:20px;
    background:#5cb85c;
    color:#fff;
    border:none;
    border-radius:10px;
    padding:14px;
    font-size:15px;
    cursor:pointer;
  }

  .cart-btn {
    width:100%;
    margin-top:10px;
    background:#111827;
    color:#fff;
    border:none;
    border-radius:10px;
    padding:14px;
    font-size:15px;
  }
</style>

<div class="container py-4">
  <div class="row">

    <!-- LEFT -->
    <div class="col-lg-7">

      <!-- ADDRESS -->
      <div class="checkout-card">
        <h6 class="fw-semibold mb-3">Ship to</h6>

        <div id="selectedAddress">
          <% if (defaultAddress) { %>
            <p><strong><%= user.name %></strong></p>
            <p><%= defaultAddress.building_name %></p>
            <p><%= defaultAddress.address_line_1 %></p>
            <p><%= defaultAddress.city %>, <%= defaultAddress.state %> <%= defaultAddress.postal_code %></p>
            <p><%= defaultAddress.country %></p>
          <% } %>
        </div>

        <select class="form-select mt-3" id="addressSelect">
          <% addresses.forEach(addr => { %>
            <option value="<%= addr.address_id %>"
              <%= defaultAddress && addr.address_id === defaultAddress.address_id ? 'selected' : '' %>>
              <%= addr.building_name %>, <%= addr.city %>, <%= addr.state %>
            </option>
          <% }) %>
          <option value="add_new">➕ Add new address</option>
        </select>
      </div>

      <!-- PAYMENT -->
      <div class="checkout-card">
        <h6 class="fw-semibold mb-2">Payment</h6>

        <label class="payment-option">
          <input type="radio" name="paymentMethodRadio" value="cod" checked>
          Cash on Delivery (COD)
        </label>

        <label class="payment-option">
          <input type="radio" name="paymentMethodRadio" value="stripe">
          Card
        </label>

        <!-- ✅ WALLET -->
        <label class="payment-option">
          <input type="radio" name="paymentMethodRadio" value="wallet">
          Wallet
        </label>
      </div>

      <!-- COUPONS -->
      <div class="checkout-card">
        <h6 class="fw-semibold mb-3">Available Coupons</h6>

        <select class="form-select" id="couponSelect">
          <option value="">Select coupon</option>
          <% coupons.forEach(c => { %>
            <option
              value="<%= c.code %>"
              <%= c.disabled ? 'disabled' : '' %>>
              <%= c.code %> - <%= c.description %>
              <%= c.disabled && c.reason ? `(${c.reason})` : '' %>
            </option>
          <% }) %>
        </select>

        <button class="btn btn-dark w-100 mt-2" id="applyCouponBtn">Apply Coupon</button>

        <% if (appliedCoupon) { %>
          <button class="btn btn-outline-danger w-100 mt-2" id="removeCouponBtn">Remove Coupon</button>
        <% } %>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="col-lg-5">
      <div class="summary-box">

        <h6 class="fw-semibold mb-3">Order Summary</h6>

        <% cart.items.forEach(item => { %>
          <div class="d-flex align-items-start mb-3">
            <img src="/uploads/<%= item.image %>" width="60" class="rounded">

            <div class="ms-3 flex-grow-1">
              <div class="fw-medium"><%= item.name %></div>
              <div class="text-muted small"><%= item.variant %></div>
              <div class="text-muted small">Qty × <%= item.quantity %></div>

              <% if (item.priceMessage) { %>
                <div class="small text-success fw-semibold mt-1">
                  <%= item.priceMessage %>
                </div>
              <% } %>
            </div>

            <div class="fw-semibold text-nowrap">
              ₹ <%= item.itemTotal %>
            </div>
          </div>
        <% }) %>

        <hr>

        <div class="d-flex justify-content-between mb-2">
          <span>Item Total</span>
          <span>₹ <%= summary.subtotal %></span>
        </div>

        <% if (summary.discount > 0) { %>
          <div class="d-flex justify-content-between mb-2">
            <span>Coupon (<%= appliedCoupon.coupon_code %>)</span>
            <span class="text-success">- ₹ <%= summary.discount %></span>
          </div>
        <% } %>

        <div class="d-flex justify-content-between mb-2">
          <span>Shipping</span>
          <span class="text-success">Free</span>
        </div>

        <hr>

        <div class="d-flex justify-content-between fs-5 fw-bold">
          <span>Total</span>
          <span>₹ <%= summary.total %></span>
        </div>

        <button id="payNowBtn" class="pay-btn">Pay now</button>

        <form action="/user/cart" method="get">
          <button class="cart-btn">Back to cart</button>
        </form>

      </div>
    </div>

  </div>
</div>

<!-- <script>
  const addressSelect = document.getElementById('addressSelect');
  const payBtn = document.getElementById('payNowBtn');

  function getSelectedPayment() {
    const checked = document.querySelector('input[name="paymentMethodRadio"]:checked');
    return checked ? checked.value : 'cod';
  }

  function getAddressId() {
    return addressSelect.value;
  }

  addressSelect.addEventListener('change', () => {
    if (addressSelect.value === 'add_new') {
      window.location.href = '/user/address/add';
    }
  });

  payBtn.addEventListener('click', async () => {
    const paymentMethod = getSelectedPayment();
    const addressId = getAddressId();

    if (!addressId || addressId === 'add_new') {
      alert('Please select a valid address');
      return;
    }

    // // COD
    // if (paymentMethod === 'cod') {
    //   const form = document.createElement('form');
    //   form.method = 'POST';
    //   form.action = '/user/checkout/pay';

    //   const addr = document.createElement('input');
    //   addr.type = 'hidden';
    //   addr.name = 'address_id';
    //   addr.value = addressId;

    //   form.appendChild(addr);
    //   document.body.appendChild(form);
    //   form.submit();
    //   return;
    // }
    // COD
    if (paymentMethod === 'cod') {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/user/checkout/pay';

      const addr = document.createElement('input');
      addr.type = 'hidden';
      addr.name = 'address_id';
      addr.value = addressId;

      form.appendChild(addr);
      document.body.appendChild(form);
      form.submit();
      return;
    }


    // WALLET
    // if (paymentMethod === 'wallet') {
    //   const res = await fetch('/user/checkout/pay-wallet', {
    //     method: 'POST',
    //     headers: { 'Content-Type': 'application/json' },
    //     body: JSON.stringify({ address_id: addressId })
    //   });

    //   const data = await res.json();

    //   if (data.success && data.redirect) {
    //     window.location.href = data.redirect;
    //   } else {
    //     window.location.href = '/user/payment-failed';
    //   }
    //   return;
    // }

      if (paymentMethod === 'wallet') {
    const res = await fetch('/user/checkout/pay-wallet', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ address_id: addressId })
    });

    const data = await res.json();

    if (data.redirect) {
      window.location.href = data.redirect;
    } else {
      window.location.href = '/user/payment-failed?reason=PAYMENT_FAILED';
    }
    return;
  }

    // STRIPE
  //   const res = await fetch('/user/checkout/stripe/create-session', {
  //     method: 'POST',
  //     headers: { 'Content-Type': 'application/json' },
  //     body: JSON.stringify({ address_id: addressId })
  //   });

  //   const data = await res.json();
  //   if (data.url) {
  //     window.location.href = data.url;
  //   } else {
  //     alert(data.error || 'Payment failed');
  //   }
  // });

const res = await fetch('/user/checkout/stripe/create-session', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ address_id: addressId })
});

const data = await res.json();

if (data.url) {
  window.location.href = data.url;
} 
else {
  window.location.href = '/user/payment-failed?reason=PAYMENT_FAILED';
}

</script> -->

<script>
  const addressSelect = document.getElementById('addressSelect');
  const payBtn = document.getElementById('payNowBtn');

  function getSelectedPayment() {
    const checked = document.querySelector('input[name="paymentMethodRadio"]:checked');
    return checked ? checked.value : 'cod';
  }

  function getAddressId() {
    return addressSelect.value;
  }

  addressSelect.addEventListener('change', () => {
    if (addressSelect.value === 'add_new') {
      window.location.href = '/user/address/add';
    }
  });

  payBtn.addEventListener('click', async () => {
    const paymentMethod = getSelectedPayment();
    const addressId = getAddressId();

    if (!addressId || addressId === 'add_new') {
      alert('Please select a valid address');
      return;
    }

    /* ================= COD ================= */
    if (paymentMethod === 'cod') {
      const res = await fetch('/user/checkout/pay', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ address_id: addressId })
      });

      if (res.redirected) {
        window.location.href = res.url;
        return;
      }

      const data = await res.json().catch(() => null);
      window.location.href =
        `/user/payment-failed?reason=${data?.error || 'PAYMENT_FAILED'}`;
      return;
    }

    /* ================= WALLET ================= */
    else if (paymentMethod === 'wallet') {
      const res = await fetch('/user/checkout/pay-wallet', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ address_id: addressId })
      });

      const data = await res.json();

      if (data.redirect) {
        window.location.href = data.redirect;
      } else {
        window.location.href = '/user/payment-failed?reason=PAYMENT_FAILED';
      }
      return;
    }

    /* ================= STRIPE ================= */
    else if (paymentMethod === 'stripe') {
      const res = await fetch('/user/checkout/stripe/create-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ address_id: addressId })
      });

      const data = await res.json();

      if (data.url) {
        window.location.href = data.url;
      } else {
        window.location.href = '/user/payment-failed?reason=PAYMENT_FAILED';
      }
      return;
    }
  });
</script>

<script>
  document.getElementById('applyCouponBtn')?.addEventListener('click', async () => {
    const code = document.getElementById('couponSelect').value;
    if (!code) return alert('Select a coupon');

    await fetch('/user/coupon/apply', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code })
    });

    location.reload();
  });

  document.getElementById('removeCouponBtn')?.addEventListener('click', async () => {
    await fetch('/user/coupon/remove', { method: 'DELETE' });
    location.reload();
  });
</script>

<%- include('./userPartials/footer') %>
