<%- include('./userPartials/navbar') %>

<style>
  body { background:#fafafa; }

  .checkout-card {
    background:#fff;
    border-radius:12px;
    padding:20px;
    margin-bottom:16px;
    border:1px solid #eaeaea;
  }

  .address p { margin:4px 0; font-size:14px; }

  .payment-option {
    border:1px solid #e5e7eb;
    border-radius:10px;
    padding:14px;
    display:flex;
    align-items:center;
    gap:10px;
    cursor:pointer;
    margin-bottom:10px;
    font-size:14px;
  }

  .payment-option input { accent-color:#111; }

  .payment-option.disabled {
    opacity:.5;
    cursor:not-allowed;
  }

  .summary-box {
    background:#fff;
    border-radius:12px;
    padding:20px;
    border:1px solid #eaeaea;
    position:sticky;
    top:20px;
  }

  .pay-btn {
    width:100%;
    margin-top:20px;
    background:#5cb85c;
    color:#fff;
    border:none;
    border-radius:10px;
    padding:14px;
    font-size:15px;
    cursor:pointer;
  }

  .cart-btn {
    width:100%;
    margin-top:10px;
    background:#111827;
    color:#fff;
    border:none;
    border-radius:10px;
    padding:14px;
    font-size:15px;
  }
</style>

<div class="container py-4">
  <div class="row">

    <!-- LEFT -->
    <div class="col-lg-7">

      <!-- ADDRESS -->
      <div class="checkout-card address">
        <h6 class="fw-semibold mb-3">Ship to</h6>

        <div id="selectedAddress">
          <% if (defaultAddress) { %>
            <p><strong><%= user.name %></strong></p>
            <p><%= defaultAddress.building_name %></p>
            <p><%= defaultAddress.address_line_1 %></p>
            <p><%= defaultAddress.city %>, <%= defaultAddress.state %> <%= defaultAddress.postal_code %></p>
            <p><%= defaultAddress.country %></p>
          <% } %>
        </div>

        <select class="form-select mt-3" id="addressSelect">
          <% addresses.forEach(addr => { %>
            <option value="<%= addr.address_id %>"
              <%= defaultAddress && addr.address_id === defaultAddress.address_id ? 'selected' : '' %>>
              <%= addr.building_name %>, <%= addr.city %>, <%= addr.state %>
            </option>
          <% }) %>
          <option value="add_new">➕ Add new address</option>
        </select>
      </div>

      <!-- PAYMENT -->
      <div class="checkout-card">
        <h6 class="fw-semibold mb-2">Payment</h6>

        <label class="payment-option">
          <input type="radio" name="paymentMethodRadio" value="cod" checked>
          Cash on Delivery (COD)
        </label>

        <label class="payment-option disabled">
          <input type="radio" disabled> Cards / UPI / Wallet (Coming Soon)
        </label>
      </div>
      <div class="checkout-card">
        <h6 class="fw-semibold mb-3">Available Coupons</h6>

        <select class="form-select" id="couponSelect">
          <option value="">Select coupon</option>
          <% coupons.forEach(c => { %>
            <option value="<%= c.code %>" <%= c.disabled ? 'disabled' : '' %>>
              <%= c.code %> - <%= c.description %>
              <%= c.disabled ? '(' + c.reason + ')' : '' %>
            </option>
          <% }) %>
        </select>

        <button class="btn btn-dark w-100 mt-2" id="applyCouponBtn">
          Apply Coupon
        </button>

        <% if (appliedCoupon) { %>
          <button class="btn btn-outline-danger w-100 mt-2" id="removeCouponBtn">
            Remove Coupon
          </button>
        <% } %>
      </div>

    </div>

    <!-- RIGHT -->
    <div class="col-lg-5">
      <div class="summary-box">

        <h6 class="fw-semibold mb-3">Order Summary</h6>

        <% cart.items.forEach(item => { %>
          <div class="d-flex mb-3">
            <img src="/uploads/<%= item.image %>" width="60" class="rounded">
            <div class="ms-3">
              <div><%= item.name %></div>
              <div class="text-muted small"><%= item.variant %></div>
              <div class="text-muted small">Qty × <%= item.quantity %></div>
            </div>
            <div class="ms-auto fw-semibold">
              ₹ <%= item.itemTotal %>
            </div>
          </div>
        <% }) %>

        <hr>

        <!-- SUBTOTAL -->
        <div class="d-flex justify-content-between mb-2">
          <span>Item Total</span>
          <span>₹ <%= summary.subtotal %></span>
        </div>

        <!-- COUPON DISCOUNT -->
        <% if (summary.discount > 0) { %>
          <div class="d-flex justify-content-between mb-2">
            <span>
              Coupon Discount
              <% if (appliedCoupon?.couponCode) { %>
                (<%= appliedCoupon.couponCode %>)
              <% } %>
            </span>
            <span class="text-success">
              - ₹ <%= summary.discount %>
            </span>
          </div>
        <% } %>

        <!-- SHIPPING -->
        <div class="d-flex justify-content-between mb-2">
          <span>Shipping</span>
          <span class="text-success">
            <%= summary.shipping === 0 ? 'Free' : '₹ ' + summary.shipping %>
          </span>
        </div>

        <hr>

        <!-- TOTAL -->
        <div class="d-flex justify-content-between fs-5 fw-bold">
          <span>Total</span>
          <span>₹ <%= summary.total %></span>
        </div>

        <!-- PAY FORM -->
        <form method="POST" action="/user/checkout/pay">
          <input type="hidden" name="paymentMethod" value="cod">
          <input type="hidden" name="address_id" id="addressInput">
          <button class="pay-btn" type="submit">Pay now</button>
        </form>

        <form action="/user/cart" method="get">
          <button class="cart-btn">Back to cart</button>
        </form>

      </div>
    </div>

  </div>
</div>

<script>
  const addresses = <%- JSON.stringify(addresses) %>;
  const addressSelect = document.getElementById('addressSelect');
  const addressInput = document.getElementById('addressInput');
  const addressContainer = document.getElementById('selectedAddress');

  addressInput.value = addressSelect.value;

  addressSelect.addEventListener('change', () => {
    if (addressSelect.value === 'add_new') {
      window.location.href = '/user/address/add';
      return;
    }

    addressInput.value = addressSelect.value;

    const addr = addresses.find(a => a.address_id === addressSelect.value);
    addressContainer.innerHTML = `
      <p><strong><%= user.name %></strong></p>
      <p>${addr.building_name}</p>
      <p>${addr.address_line_1}</p>
      <p>${addr.city}, ${addr.state} ${addr.postal_code}</p>
      <p>${addr.country}</p>
    `;
  });
</script>
<script>
  document.getElementById('applyCouponBtn')?.addEventListener('click', async () => {
    const code = document.getElementById('couponSelect').value;
    if (!code) return alert('Select a coupon');

    const res = await fetch('/user/coupon/apply', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code })
    });

    const data = await res.json();
    if (data.error) return alert(data.error);

    location.reload();
  });

  document.getElementById('removeCouponBtn')?.addEventListener('click', async () => {
    await fetch('/user/coupon/remove', { method: 'DELETE' });
    location.reload();
  });
</script>


<%- include('./userPartials/footer') %>
