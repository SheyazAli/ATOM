<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Addresses | ATOM</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

<style>
  .address-input {
    background: #fff5f5;
    border: none;
    padding: 14px;
    border-radius: 10px;
  }

  .address-input:focus {
    box-shadow: none;
    outline: none;
  }

  .btn-save {
    background: #198754;
    color: #fff;
    padding: 14px;
    border-radius: 12px;
    border: none;
  }

  .btn-save:hover {
    background: #157347;
  }
  .address-input.is-invalid {
  border: 1px solid #dc3545;
}

.address-input.is-invalid + .invalid-feedback {
  display: block;
}

.invalid-feedback {
  display: none;
  font-size: 12px;
}

</style>
</head>

<body>

<%- include('./userPartials/navbar') %>

<div class="container account-wrapper">
  <div class="row">

    <%- include('./userPartials/sidebar') %>

    <div class="col-lg-9">
      <h3 class="mb-4">Addresses</h3>

      <form id="addAddressForm">
        <div class="row g-4">

          <div class="col-md-6">
            <input name="first_name" class="address-input w-100" placeholder="First name">
            <div class="invalid-feedback">This field cannot be empty</div>
          </div>

          <div class="col-md-6">
            <input name="last_name" class="address-input w-100" placeholder="Last name" required>
          </div>

          <div class="col-12">
            <input name="building_name" class="address-input w-100" placeholder="Flat/House No / Building name">
            <div class="invalid-feedback">This field cannot be empty</div>
          </div>

          <div class="col-12">
            <input name="address_line_1" class="address-input w-100" placeholder="Address line 1" required>
            <div class="invalid-feedback">This field cannot be empty</div>
          </div>

          <div class="col-12">
            <input name="address_line_2" class="address-input w-100" placeholder="Address line 2">
          </div>

          <div class="col-md-4">
            <input name="city" class="address-input w-100" placeholder="City" required>
            <div class="invalid-feedback">This field cannot be empty</div>
          </div>

          <div class="col-md-4">
            <input name="state" class="address-input w-100" placeholder="State" required>
            <div class="invalid-feedback">This field cannot be empty</div>
          </div>

          <div class="col-md-4">
            <input name="country" class="address-input w-100" placeholder="Country" required>
            <div class="invalid-feedback">This field cannot be empty</div>
          </div>

          <div class="col-md-6">
            <input name="postal_code" class="address-input w-100" placeholder="Postal code"
               inputmode="numeric" maxlength="6">
               <div class="invalid-feedback">Postal code must be 6 digits</div>
          </div>

          <div class="col-md-6">
            <input name="phone_number" class="address-input w-100" placeholder="Mobile number"
              inputmode="numeric" maxlength="10">
              <div class="invalid-feedback">Mobile number must be 10 digits</div>
          </div>

          <div class="col-md-12">
            <input name="email" class="address-input w-100" placeholder="Email ID">
            <div class="invalid-feedback">Enter a valid email address</div>
          </div>

          <div class="col-12">
            <input type="checkbox" name="is_default"> Set as default address
          </div>

          <div class="col-md-6">
            <button class="btn-save w-100">ADD ADDRESS</button>
          </div>

          <div class="col-md-6">
            <a href="/user/home" class="btn btn-outline-success w-100">CANCEL</a>
          </div>

        </div>
      </form>

    </div>
  </div>
</div>

<%- include('./userPartials/footer') %>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
const form = document.getElementById('addAddressForm');

const rules = {
  first_name: v => v.trim() !== '',
  building_name: v => v.trim() !== '',
  address_line_1: v => v.trim() !== '',
  city: v => v.trim() !== '',
  state: v => v.trim() !== '',
  country: v => v.trim() !== '',
  email: v => !v || /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v),
  postal_code: v => !v || /^\d{6}$/.test(v),
  phone_number: v => !v || /^\d{10}$/.test(v)
};

function validateField(input) {
  const rule = rules[input.name];
  if (!rule) return true;

  const valid = rule(input.value);
  input.classList.toggle('is-invalid', !valid);
  return valid;
}

// validate on blur
form.querySelectorAll('input').forEach(input => {
  input.addEventListener('blur', () => validateField(input));
});

// validate on submit
form.addEventListener('submit', async (e) => {
  e.preventDefault();

  let valid = true;
  form.querySelectorAll('input').forEach(input => {
    if (!validateField(input)) valid = false;
  });

  if (!valid) return;

  const data = Object.fromEntries(new FormData(form).entries());

  try {
    const res = await fetch('/user/address', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    const result = await res.json();
    if (!res.ok) throw new Error(result.message);

    window.location.href = result.redirect;

  } catch {
    alert('Something went wrong. Try again.');
  }
});
</script>


<script>
document.getElementById('addAddressForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const form = e.target;
  const formData = new FormData(form);
  const data = Object.fromEntries(formData.entries());

  try {
    const res = await fetch('/user/address', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    const result = await res.json();

    if (!res.ok) {
      return Swal.fire({
        icon: 'error',
        title: 'Validation Error',
        text: result.message
      });
    }

    window.location.href = result.redirect;

  } catch (err) {
    Swal.fire({
      icon: 'error',
      title: 'Network Error',
      text: 'Please try again later'
    });
  }
});
</script>

</body>
</html>
