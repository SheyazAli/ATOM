<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title><%= product.title %></title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body { background:#fff; }

    .image-wrapper {
      width: 100%;
      aspect-ratio: 5 / 7;
      overflow: hidden;
    }

    .main-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      cursor: zoom-in;
    }
    /* CATEGORY OFFER MARQUEE */
  .offer-marquee {
    overflow: hidden;
    white-space: nowrap;
    position: relative;
    background: #f0fff4;
    padding: 6px 0;
    margin-bottom: 12px;
  }

  .offer-text {
    display: inline-block;
    padding-left: 100%;
    animation: marquee 12s linear infinite;
    font-size: 12px;
    color: #16a34a;
    font-weight: 500;
  }

  @keyframes marquee {
    from { transform: translateX(0); }
    to { transform: translateX(-100%); }
  }

    .thumb {
      width: 90px;
      aspect-ratio: 5 / 7;
      object-fit: cover;
      cursor: pointer;
    }

    .option-box {
      border: 1px solid #ccc;
      padding: 10px 16px;
      margin-right: 8px;
      cursor: pointer;
      min-width: 70px;
      text-align: center;
    }

    .option-active { border: 2px solid #000; }
    .option-disabled { opacity: .4; pointer-events:none; }

    .stock-text { font-size: 12px; }
    .low-stock { color:#c0392b; }
    .out-stock { color:#999; }

    .rating-stars i { color:#f5a623; }

    .modal-content { background:#000; }

    .zoom-container {
      position: absolute;
      inset: 0;
      overflow: hidden;
      cursor: grab;
    }

    .zoom-img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      transition: transform .15s ease;
      transform-origin: center center;
    }

    .zoom-close {
      position: absolute;
      top: 16px;
      right: 16px;
      z-index: 10;
    }
  </style>
</head>

<body>

<%- include('./userPartials/navbar') %>

<div class="container py-4">
  <% if (category && category.hasOffer && category.offer && category.offer.active) { %>
  <div class="offer-marquee">
    <div class="offer-text">
      GET <%= category.offer.discount_value %>
      <%= category.offer.discount_type.toUpperCase() %>
      OFF ON ALL PRODUCTS AT THIS CATEGORY.
      YOU CAN CLAIM THIS AT CHECKOUT. t&c applied*
    </div>
  </div>
<% } %>


  <!-- BREADCRUMB -->
  <nav class="breadcrumb mb-4">
    <a class="breadcrumb-item text-decoration-none" href="/user/home">Home</a>
    <a class="breadcrumb-item text-decoration-none" href="/user/products">Products</a>
    <span class="breadcrumb-item active"><%= product.title %></span>
  </nav>

  <div class="row">

    <!-- LEFT -->
    <div class="col-lg-6">
      <div class="image-wrapper mb-3">
        <img id="mainImage"
             class="main-img"
             data-bs-toggle="modal"
             data-bs-target="#zoomModal">
      </div>
      <div id="thumbs" class="d-flex gap-2"></div>
    </div>

    <!-- RIGHT -->
    <div class="col-lg-6">
      <h3><%= product.title %></h3>

      <div class="rating-stars mb-2">
        <% for(let i=0;i<5;i++){ %>
          <i class="bi bi-star-fill"></i>
        <% } %>
        <span class="text-muted ms-2">(4.6 / 5)</span>
      </div>

      <div class="mb-3">
        <span class="text-decoration-line-through text-muted">
          ₹ <%= product.regular_price %>
        </span>
        <span class="fs-4 fw-bold ms-2">
          ₹ <%= product.sale_price %>
        </span>
      </div>

      <h6>Color</h6>
      <div class="d-flex mb-3">
        <% colors.forEach(c => { %>
          <div class="option-box color-box" data-color="<%= c %>"><%= c %></div>
        <% }) %>
      </div>

      <h6>Size</h6>
      <div id="sizes" class="d-flex mb-4"></div>

      <button id="addToCartBtn"
        class="btn btn-success w-100 mb-2"
        <%= isOutOfStock ? 'disabled' : '' %>>
        ADD TO CART
      </button>

      <button
        id="wishlistBtn"
        class="btn btn-outline-dark w-100"
        <%= isOutOfStock ? 'disabled' : '' %>>
        ❤️ MOVE TO WISHLIST
      </button>
    </div>
  </div>
</div>

<!-- RELATED PRODUCTS -->
<div class="container pb-5">
  <h4 class="fw-semibold mb-4">Related Products</h4>
  <div class="row g-4">
    <% relatedProducts.forEach(p => { %>
      <div class="col-lg-3 col-md-4 col-sm-6">
        <a href="/user/product/<%= p.product_id %>" class="text-decoration-none text-dark">
          <div class="card h-100 shadow-sm">
            <img src="/uploads/<%= p.thumbnail %>"
                 class="card-img-top"
                 style="aspect-ratio:5/7; object-fit:cover;">
            <div class="card-body">
              <h6><%= p.title %></h6>
              <span class="fw-semibold text-success">₹ <%= p.sale_price %></span>
              <div class="text-muted small"><%= p.colorsCount %> colors</div>
            </div>
          </div>
        </a>
      </div>
    <% }) %>
  </div>
</div>

<!-- ZOOM MODAL -->
<div class="modal fade" id="zoomModal">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content position-relative">

      <button class="btn btn-light zoom-close"
              data-bs-dismiss="modal">✕</button>

      <div class="zoom-container" id="zoomContainer">
        <img id="zoomImg" class="zoom-img">
      </div>

    </div>
  </div>
</div>

<script>
  const colorMap = <%- JSON.stringify(colorMap) %>;
  let currentColor = "<%= defaultColor %>";
  let images = [];
  let selectedVariant = null;
  let scale = 1;

  function renderImages(color) {
    images = colorMap[color].images || [];
    if (!images.length) return;

    mainImage.src = '/uploads/' + images[0];
    thumbs.innerHTML = images.map((img,i)=>
      `<img src="/uploads/${img}" class="thumb"
            onclick="mainImage.src='/uploads/${img}'">`
    ).join('');
  }

  function renderSizes(color) {
    sizes.innerHTML = colorMap[color].sizes.map(v => `
      <div class="option-box ${v.stock === 0 ? 'option-disabled' : ''}"
           data-variant="${v.variant_id}">
        ${v.size}
        <div class="stock-text ${v.stock === 0 ? 'out-stock' : 'low-stock'}">
          ${v.stock === 0 ? 'Out of stock' : v.stock < 4 ? `Only ${v.stock} left` : ''}
        </div>
      </div>
    `).join('');
  }

  document.getElementById('sizes').onclick = e => {
    const box = e.target.closest('.option-box');
    if (!box || box.classList.contains('option-disabled')) return;

    document.querySelectorAll('#sizes .option-box')
      .forEach(b => b.classList.remove('option-active'));

    box.classList.add('option-active');
    selectedVariant = box.dataset.variant;
    wishlistBtn.disabled = false;
  };

  document.querySelectorAll('.color-box').forEach(b => {
    b.onclick = () => {
      document.querySelectorAll('.color-box')
        .forEach(x => x.classList.remove('option-active'));

      b.classList.add('option-active');
      currentColor = b.dataset.color;
      selectedVariant = null;
      wishlistBtn.disabled = true;
      renderImages(currentColor);
      renderSizes(currentColor);
    };
  });

  addToCartBtn.onclick = () => {
    if (!selectedVariant) return alert('Please select size');

    fetch('/user/cart/add', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        product_id:"<%= product.product_id %>",
        variant_id:selectedVariant
      })
    }).then(()=>location.href='/user/cart');
  };

  wishlistBtn.onclick = async () => {
    if (!selectedVariant) return alert('Please select size');

    await fetch('/user/wishlist/add', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        product_id:"<%= product.product_id %>",
        variant_id:selectedVariant
      })
    });

    alert('Added to wishlist ❤️');
  };

  /* INIT */
  document.querySelector(`[data-color="${currentColor}"]`).classList.add('option-active');
  renderImages(currentColor);
  renderSizes(currentColor);

  /* ZOOM */
  zoomModal.addEventListener('shown.bs.modal', () => {
    zoomImg.src = mainImage.src;
    scale = 1;
    zoomImg.style.transform = 'scale(1)';
  });

  zoomContainer.addEventListener('wheel', e => {
    e.preventDefault();
    scale = Math.min(Math.max(1, scale + e.deltaY * -0.0015), 4);
    zoomImg.style.transform = `scale(${scale})`;
  }, { passive:false });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<%- include('./userPartials/footer') %>
</body>
</html>
